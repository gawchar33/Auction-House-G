<!DOCTYPE html>
<html ng-app="productApp">
<head>
  <meta charset="utf-8" />
  <title>Products</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
  <script src="product.js"></script>
  <style>
    /* small thumbnail style */
    .thumb { width:60px; height:40px; object-fit:cover; border-radius:6px; display:inline-block; vertical-align:middle; }
    .col-image { width:80px; text-align:center; }
  </style>
</head>
<body ng-controller="ProductController">

  <div class="customer-wrapper">
    <div class="form-card" ng-if="!categoryFilter">
      <h1 class="card-title">Add Product</h1>

      <form name="prodForm" ng-submit="editMode ? updateProduct() : createProduct()" novalidate enctype="multipart/form-data">
        <div class="row">
          <label class="field">
            <span class="label">Name</span>
            <input type="text" ng-model="product.name" placeholder="Product name" required />
          </label>

          <label class="field">
            <span class="label">Price</span>
            <input type="number" step="0.01" ng-model="product.price" placeholder="0.00" required />
          </label>
        </div>

        <div class="row">
          <label class="field">
            <span class="label">Stock</span>
            <input type="number" ng-model="product.stock" placeholder="Quantity" required />
          </label>

          <label class="field">
            <span class="label">Category (id)</span>
            <input type="text" ng-model="product.category" placeholder="Category id (optional)" />
          </label>
        </div>

        <div class="row">
          <label class="field" style="flex:1">
            <span class="label">Description</span>
            <textarea ng-model="product.description" placeholder="Short description" rows="3"></textarea>
          </label>

          <label class="field">
            <span class="label">Image</span>
            <input type="file" file-model="product.image" accept="image/*" />
          </label>
        </div>

        <div class="form-actions">
          <button class="btn primary" type="submit" ng-disabled="prodForm.$invalid">Add Product</button>
          <button class="btn neutral" type="button" ng-if="editMode" ng-click="cancelEdit()">Cancel</button>
        </div>

        <div class="status" ng-if="status">{{ status }}</div>
      </form>
    </div>

    <div class="list-card">
      <h2 class="list-title">Product List</h2>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th class="col-id">ID</th>
              <th class="col-image">Image</th>
              <th class="col-name">Name</th>
              <th class="col-price">Price</th>
              <th class="col-stock">Stock</th>
              <th class="col-category">Category</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="p in products">
              <td>{{ p.id }}</td>
              <td class="col-image">
                <img ng-if="p.image" ng-src="{{ p.image }}" alt="thumb" class="thumb" />
                <div ng-if="!p.image" style="font-size:12px;color:#6b7280">No image</div>
              </td>
              <td>{{ p.name }}</td>
              <td>{{ p.price | number:2 }}</td>
              <td>{{ p.stock }}</td>
              <td>{{ p.category }}</td>
              <td class="actions-col">
                <button class="btn small" ng-click="editProduct(p)">Edit</button>
                <button class="btn danger small" ng-click="deleteProduct(p.id)">Delete</button>
              </td>
            </tr>
            <tr ng-if="!loading && !products.length && !error">
              <td colspan="7" class="muted" ng-if="!categoryFilter">No products found.</td>
              <td colspan="7" class="muted" ng-if="categoryFilter">No products found in category "{{ categoryFilter }}".</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    angular.module('auctionApp').controller('ProductController', ['$scope','$http','$window', function($scope,$http,$window){
      $scope.products = [];
      $scope.loading = false;
      $scope.error = '';

      // read category filter from URL (supports ?category=, ?name=, ?slug=)
      try {
        var _q = new URLSearchParams(window.location.search || '');
        $scope.categoryFilter = (_q.get('category') || _q.get('name') || _q.get('slug') || '').trim();
      } catch (e) {
        $scope.categoryFilter = '';
      }
      console.log('Product page search=', window.location.search, 'categoryFilter=', $scope.categoryFilter);

      var API = (window.BACKEND || 'http://127.0.0.1:8000').replace(/\/$/,'') + '/product/';

      function normalize(data){
        if(!data) return [];
        if(Array.isArray(data)) return data;
        if(data.results && Array.isArray(data.results)) return data.results;
        return data.data || [];
      }

      $scope.load = function(){
        $scope.loading = true;
        $scope.error = '';
        $http.get(API, { withCredentials: true })
          .then(function(resp){
            $scope.products = normalize(resp.data);

            // if a category filter is present, keep only matching products
            if($scope.categoryFilter){
              var f = ($scope.categoryFilter || '').toLowerCase();
              $scope.products = $scope.products.filter(function(p){
                if(!p) return false;
                // support shapes: p.category (string), p.category.slug, p.category.name, p.cat, p.category_slug
                var cat = (p.category && (p.category.slug || p.category.name || p.category)) || p.cat || p.category_slug || '';
                return (''+cat).toLowerCase().indexOf(f) !== -1;
              });
            }

            $scope.loading = false;
          })
          .catch(function(err){
            $scope.loading = false;
            $scope.error = (err.data && (err.data.detail || err.data.error)) || ('Failed to load products (' + (err.status || 'network') + ')');
            $scope.products = [];
            console.warn('Load products failed', err);
          });
      };

      $scope.delete = function(id){
        if(!confirm('Delete product?')) return;
        $http.delete(API + id + '/', { withCredentials: true })
          .then(function(){ $scope.load(); })
          .catch(function(err){ alert('Delete failed'); console.error(err); });
      };

      $scope.load();
    }]);
  </script>
</body>
</html>
